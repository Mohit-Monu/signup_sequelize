<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
</head>

<body>
  <header id="main-header" class="bg-danger text-white p-4 mb-3">
    <h1 id="header-title">Add All Your Expenses Here.</h1>
  </header>
  <div class="container">
    <div id="main" class="card card-body">
      <form id="addForm" class="form-inline mb-3" method="post">
        <h5>Enter Your Expense Amount.</h5>
        <input id="amt" type="number" class="form-control" required />
        <br />
        <h5>Enter Your Product Discription.</h5>
        <input id="desc" type="text" class="form-control" required />
        <br />
        <h5>Choose Category.</h5>
        <select id="categ" class="form-control" required>
          <option value="">Select</option>
          <option value="Fuel">Fuel</option>
          <option value="Food">Food</option>
          <option value="Movie">Movie</option>
          <option value="Grocery">Grocery</option>
          <option value="Electricity">Electricity</option>
          <option value="Electricals">Electricals</option>
          <option value="Others.">Others.</option>
        </select>
        <br />
        <input type="submit" class="btn btn-dark col-md-4" value="Submit" />
      </form>
      <div id="buydiv">
        <!-- <button id="buy_premium">Buy Premimum</button> -->
      </div>
    </div>
    <div class="boxx">
    </div>
  </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  var box = document.querySelector(".boxx");
  document.getElementById('addForm').addEventListener('submit', addele);
  const boax = document.getElementById('buydiv');

  window.addEventListener('DOMContentLoaded', () => {
    pageloader();
  })
  async function pageloader() {
    const token = localStorage.getItem('token');
    const result1 = await axios.get('http://localhost:3000/expenses/load', { headers: { "Authorization": token } })
    const result = result1.data.result
    const user = result1.data.user[0].isPremiumUser
    console.log(user)
    // if(user===false){
    //   console.log("not a premium user")
    // }else{
    //   console.log("a premium user")
    // }
    if (user === false) {
      const butt = document.createElement('button');
      butt.id = 'buy_premium';
      butt.innerHTML = 'Buy Premimum';
      boax.appendChild(butt);
      document.getElementById('buy_premium').addEventListener('click', buypre);
    } else {
      const butt = document.createElement('h2');
      butt.innerHTML = 'You are a premium user';
      butt.style.color = 'green'
      boax.appendChild(butt);
    }
    result.forEach(element => {
      var div = document.createElement('div');
      var h1 = document.createElement('h1');
      var delbtn = document.createElement('input');
      delbtn.type = 'button'
      delbtn.value = "Delete"
      var idstore = document.createElement('input');
      idstore.value = element.id
      idstore.type = 'hidden'
      h1.innerHTML = 'Amount-' + element.expenseamount + '  Description-' + element.description + '  Category-' + element.category;
      box.appendChild(div);
      div.appendChild(idstore);
      div.appendChild(h1);
      div.appendChild(delbtn);
      delbtn.addEventListener('click', delf);
    });
  }
  async function addele(e) {
    const token = localStorage.getItem('token');
    e.preventDefault()
    var amou = document.getElementById('amt').value;
    var descr = document.getElementById('desc').value;
    var catego = document.getElementById('categ').value;
    const config = {
      method: 'POST',
      url: 'http://localhost:3000/expenses/user',
      data: {
        "amt": amou,
        "des": descr,
        "cat": catego
      },
      headers: { "Authorization": token }
    }
    await axios(config)
      .then(() => {
        console.log("added")
      }
      )
      .catch((err) => {
        console.log(err)
      });
    await delall();
    await pageloader();
  }
  async function delall() {
    return new Promise((resolve, reject) => {
      while (box.firstChild) {
        box.removeChild(box.firstChild);
      }
      while (boax.firstChild) {
        boax.removeChild(boax.firstChild);
      }
      resolve()
    })
  }
  async function delf(e) {
    const token = localStorage.getItem('token');
    var par = e.target.parentElement;
    var fc = par.firstChild;
    var id = fc.value
    const config = {
      method: 'delete',
      url: 'http://localhost:3000/expenses/del/' + id,
      headers: { "Authorization": token }
    }
    const ans = await axios(config);
    await delall();
    await pageloader();
  }
  async function buypre() {
    const token = localStorage.getItem('token');
    await axios.get('http://localhost:3000/purchase/membership', { headers: { 'Authorization': token } })
      .then((result) => {
        console.log(result)
        var options = {
          "key": result.data.key_id,
          "order_id": result.data.order.id,
          "handler": async function (result) {
            await axios.post('http://localhost:3000/purchase/updatetransaction', {
              order_id: options.order_id,
              payment_id: result.razorpay_payment_id,
            }, { headers: { 'Authorization': token } })
            alert("you are a premium user now")
            await delall();
            await pageloader();
          }
        }
        const rzp1 = new Razorpay(options);
        rzp1.open();
        e.preventDefault;
        rzp1.on('payment.failed', function (response) {
          console.log(response);
          alert('something went wrong');
        })
      })
  }
</script>

</html>